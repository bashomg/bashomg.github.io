<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wavee — Global Music Library</title>
<style>
  :root {
    /* Default theme: Black + Yellow */
    --bg:#0a0a0a; --card:#121212; --text:#ffffff; --muted:#c7c7c7;
    --border:#1f1f1f; --accent:#ffd400; --accent-2:#fff08a; --ring:#ffd40045;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Inter,Arial}
  header{position:sticky;top:0;z-index:10;background:#0a0a0ae6;padding:12px 16px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
  h1{margin:0 10px 0 0;font-size:18px;letter-spacing:.3px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f0f0f;color:var(--text);outline:none}
  .input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--ring)}
  .btn{background:#181818;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn:hover{border-color:#2a2a2a}
  .btn.primary{background:var(--accent);border-color:transparent;color:#1a1a00;font-weight:800}
  .btn.ghost{background:transparent;border-color:#2a2a2a}
  .btn.danger{background:transparent;border-color:var(--accent);color:var(--accent);font-weight:800}
  .btn.danger:hover{background:#1a1a0a}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#1b1b1b;border:1px solid var(--border);color:var(--muted)}
  .grid{display:grid;gap:14px;padding:14px 16px 120px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .thumb{width:100%;aspect-ratio:1.6/1;object-fit:cover;background:#0f0f0f}
  .meta{padding:10px 12px}
  .title{font-weight:900;font-size:14px;margin:0 0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .artist{color:var(--muted);font-size:12px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row-tight{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}

  /* Player */
  .player{position:fixed;left:0;right:0;bottom:0;background:#0c0c0c;border-top:1px solid var(--border);display:flex;gap:10px;padding:10px 14px;align-items:center}
  .pthumb{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#101010;border:1px solid var(--border)}
  .time{font-variant-numeric:tabular-nums;font-size:12px;color:var(--accent-2)}
  input[type="range"]{accent-color:var(--accent)}

  /* Modals */
  .modal{position:fixed;inset:0;display:none;place-items:center;z-index:50}
  .modal.open{display:grid}
  .panel{width:min(780px,94vw);background:#121212;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 30px 80px rgba(0,0,0,.6)}
  .muted{color:var(--muted);font-size:13px;margin:6px 0 0}
  .drop{border:1.5px dashed #2e2e2e;border-radius:14px;padding:14px;text-align:center;background:#0f0f0f;margin-top:8px}
  .drop.drag{border-color:var(--accent);background:#13130c}

  /* Comments */
  .c-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .c-head img{width:48px;height:48px;border-radius:8px;border:1px solid var(--border);object-fit:cover}
  .c-title{font-weight:900;margin:0}
  .c-artist{margin:0;color:var(--muted);font-size:13px}
  .clist{display:flex;flex-direction:column;gap:10px;max-height:50vh;overflow:auto;margin:10px 0}
  .citem{display:flex;gap:10px;background:#151515;border:1px solid var(--border);padding:10px;border-radius:12px}
  .cmeta{color:var(--accent);font-size:12px}
  .cbody{margin:2px 0 0}
  .cform{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .cform .input{flex:1}

  /* Theme panel */
  .swatch{width:22px;height:22px;border-radius:6px;border:1px solid var(--border);cursor:pointer}
  .color-row{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
  .color-row input[type="color"]{width:100%;height:38px;border:1px solid var(--border);border-radius:10px;background:#0f0f0f}

  /* Toast & FAB */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#141414;color:#fff7cc;border:1px solid #2a2a2a;padding:10px 14px;border-radius:12px;display:none;z-index:60}
  .adminFab{position:fixed;right:16px;bottom:90px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:40}
</style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Wavee</h1>
      <input id="search" class="input" placeholder="Search title or artist…"/>
      <span id="status" class="pill">Viewer</span>
      <button id="themeBtn" class="btn">Theme</button>
      <button id="adminBtn" class="btn primary">Admin</button>
    </div>
  </header>

  <main id="grid" class="grid" aria-live="polite"></main>

  <!-- Player -->
  <div class="player" aria-label="Player">
    <img id="pthumb" class="pthumb" alt="">
    <div style="min-width:0;display:flex;flex-direction:column">
      <p id="ptitle" style="margin:0;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Nothing playing</p>
      <p id="partist" style="margin:0;color:var(--accent-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">—</p>
    </div>
    <button id="playPause" class="btn">Play</button>
    <span id="curTime" class="time">0:00</span>
    <input id="seek" type="range" min="0" max="100" value="0" style="flex:1"/>
    <span id="dur" class="time">0:00</span>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:110px">
  </div>

  <!-- Password modal -->
  <div id="pwModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Unlock Admin</h3>
      <p class="muted">Enter the password to enable uploads and deletion.</p>
      <div class="row" style="margin-top:10px">
        <input id="pw" type="password" class="input" placeholder="Password" style="flex:1">
        <button id="unlock" class="btn primary">Unlock</button>
        <button id="cancelPw" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Upload modal -->
  <div id="upModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Upload Track</h3>
      <div id="drop" class="drop">Drop .mp3/.wav here or click to choose</div>
      <input id="audioInput" type="file" accept=".mp3,.wav,audio/mpeg,audio/wav" hidden>
      <div class="row" style="margin-top:10px">
        <input id="titleIn" class="input" placeholder="Title *" style="flex:1">
        <input id="artistIn" class="input" placeholder="Artist *" style="flex:1">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="thumbUrlIn" class="input" placeholder="Thumbnail URL (optional)" style="flex:1">
        <label class="btn">Choose Image<input id="thumbFileIn" type="file" accept="image/*" hidden></label>
      </div>
      <div class="row" style="margin-top:10px">
        <progress id="prog" max="100" value="0" style="width:220px;height:16px"></progress>
        <span id="meta" class="muted">No file</span>
        <span id="durProbe" class="muted"></span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="save" class="btn primary">Save</button>
        <button id="cancelUpload" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Comments modal -->
  <div id="cModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <div class="c-head">
        <img id="cThumb" alt="">
        <div style="flex:1;min-width:0">
          <p id="cTitle" class="c-title"></p>
          <p id="cArtist" class="c-artist"></p>
        </div>
        <button id="cClose" class="btn">Close</button>
      </div>
      <div id="cList" class="clist" aria-live="polite"></div>
      <form id="cForm" class="cform">
        <input id="cName" class="input" placeholder="Your name (optional)">
        <input id="cBody" class="input" placeholder="Write a comment…" maxlength="500" required>
        <button id="cPost" class="btn primary" type="submit">Post</button>
      </form>
    </div>
  </div>

  <!-- Theme modal -->
  <div id="themeModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Theme</h3>
      <p class="muted">Pick a preset or customize colors. Your choice is saved on this device.</p>
      <div class="row" style="margin-top:8px; flex-wrap:wrap">
        <button class="btn ghost" data-preset="yellow"><span class="swatch" style="background:#ffd400"></span> &nbsp;Yellow</button>
        <button class="btn ghost" data-preset="orange"><span class="swatch" style="background:#ff7a00"></span> &nbsp;Orange</button>
        <button class="btn ghost" data-preset="electric"><span class="swatch" style="background:#6ae3ff"></span> &nbsp;Electric</button>
        <button class="btn ghost" data-preset="purple"><span class="swatch" style="background:#c79dff"></span> &nbsp;Purple</button>
      </div>
      <div style="margin-top:12px; display:grid; gap:10px">
        <div class="color-row"><label>Background</label><input id="cBg" type="color" value="#0a0a0a"></div>
        <div class="color-row"><label>Card</label><input id="cCard" type="color" value="#121212"></div>
        <div class="color-row"><label>Text</label><input id="cText" type="color" value="#ffffff"></div>
        <div class="color-row"><label>Muted Text</label><input id="cMuted" type="color" value="#c7c7c7"></div>
        <div class="color-row"><label>Border</label><input id="cBorder" type="color" value="#1f1f1f"></div>
        <div class="color-row"><label>Accent</label><input id="cAccent" type="color" value="#ffd400"></div>
        <div class="color-row"><label>Accent 2</label><input id="cAccent2" type="color" value="#fff08a"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="themeApply" class="btn primary">Apply</button>
        <button id="themeClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <button id="uploadFab" class="btn primary adminFab" style="display:none">Upload</button>
  <div id="toast" class="toast"></div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
/* === CONFIG === */
const SUPABASE_URL = "https://hjcufpeuyoupaxkqwwnz.supabase.co";
const SUPABASE_ANON = "sb_publishable_XhQqm90hkkeNLbsv2R33nw_XQZ61S7w";
const PASSWORD = "intelz";
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

/* === UI refs === */
const $ = s => document.querySelector(s);
const grid = $('#grid'), search = $('#search'), statusPill = $('#status');
const themeBtn = $('#themeBtn'), themeModal = $('#themeModal');
const pwModal = $('#pwModal'), upModal = $('#upModal'), cModal = $('#cModal');
const adminBtn = $('#adminBtn'), uploadFab = $('#uploadFab');
const pwInput = $('#pw'), unlockBtn = $('#unlock'), cancelPw = $('#cancelPw');

const drop = $('#drop'), audioInput = $('#audioInput');
const titleIn = $('#titleIn'), artistIn = $('#artistIn');
const thumbUrlIn = $('#thumbUrlIn'), thumbFileIn = $('#thumbFileIn');
const prog = $('#prog'), meta = $('#meta'), durProbe = $('#durProbe');
const saveBtn = $('#save'), cancelUpload = $('#cancelUpload');

const toastEl = $('#toast');
const playBtn = $('#playPause'), seek = $('#seek'), vol = $('#vol');
const curTimeEl = $('#curTime'), durEl = $('#dur');
const pthumb = $('#pthumb'), ptitle = $('#ptitle'), partist = $('#partist');

/* Comments refs */
const cThumb = $('#cThumb'), cTitle = $('#cTitle'), cArtist = $('#cArtist');
const cList = $('#cList'), cForm = $('#cForm'), cName = $('#cName'), cBody = $('#cBody'), cClose = $('#cClose');

/* Theme refs */
const cBg = $('#cBg'), cCard = $('#cCard'), cText = $('#cText'), cMuted = $('#cMuted'), cBorder = $('#cBorder'), cAccent = $('#cAccent'), cAccent2 = $('#cAccent2');

/* === State === */
let ADMIN_ENABLED = false;
let TRACKS = [];
let FILTER = '';
let seeking=false;
let currentTrack = null;
let currentCommentsPoll = null;
const audio = new Audio(); audio.preload='metadata'; audio.crossOrigin='anonymous'; vol.value=1;

/* === Themes === */
const PRESETS = {
  yellow: { bg:'#0a0a0a', card:'#121212', text:'#ffffff', muted:'#c7c7c7', border:'#1f1f1f', accent:'#ffd400', accent2:'#fff08a' },
  orange: { bg:'#0a0a0a', card:'#121212', text:'#ffffff', muted:'#b3b3b3', border:'#1f1f1f', accent:'#ff7a00', accent2:'#ffb56b' },
  electric:{ bg:'#05060a', card:'#0b0f1a', text:'#e9f4ff', muted:'#b8cbe0', border:'#132033', accent:'#6ae3ff', accent2:'#b7f2ff' },
  purple: { bg:'#0b0911', card:'#130f1e', text:'#f6f0ff', muted:'#cdbef0', border:'#221b36', accent:'#c79dff', accent2:'#eddcff' }
};
function applyTheme(vars){
  const root = document.documentElement.style;
  root.setProperty('--bg', vars.bg);
  root.setProperty('--card', vars.card);
  root.setProperty('--text', vars.text);
  root.setProperty('--muted', vars.muted);
  root.setProperty('--border', vars.border);
  root.setProperty('--accent', vars.accent);
  root.setProperty('--accent-2', vars.accent2);
  root.setProperty('--ring', hexToRgba(vars.accent, 0.27));
  localStorage.setItem('wavee_theme', JSON.stringify(vars));
}
function loadTheme(){
  const raw = localStorage.getItem('wavee_theme');
  if (!raw) return;
  try { const t = JSON.parse(raw); applyTheme(t); syncPickers(t); } catch {}
}
function syncPickers(t){
  cBg.value = toHex(t.bg); cCard.value = toHex(t.card); cText.value = toHex(t.text);
  cMuted.value = toHex(t.muted); cBorder.value = toHex(t.border);
  cAccent.value = toHex(t.accent); cAccent2.value = toHex(t.accent2);
}
function getPickers(){
  return {
    bg:cBg.value, card:cCard.value, text:cText.value, muted:cMuted.value, border:cBorder.value,
    accent:cAccent.value, accent2:cAccent2.value
  };
}
function toHex(v){ // supports rgb() or hex input
  if (/^#/.test(v)) return v;
  const m = v.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i); if(!m) return '#ffffff';
  const [r,g,b] = [m[1],m[2],m[3]].map(Number);
  return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
}
function hexToRgba(hex, a){
  if (!/^#/.test(hex)) return hex;
  const h = hex.replace('#',''); const n = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
  const r = parseInt(n.slice(0,2),16), g=parseInt(n.slice(2,4),16), b=parseInt(n.slice(4,6),16);
  return `rgba(${r}, ${g}, ${b}, ${a})`;
}

/* Theme modal wiring */
themeBtn.addEventListener('click', ()=>{ themeModal.classList.add('open'); const t = JSON.parse(localStorage.getItem('wavee_theme')||'null') || PRESETS.yellow; syncPickers(t); });
$('#themeClose').addEventListener('click', ()=> themeModal.classList.remove('open'));
$('#themeApply').addEventListener('click', ()=>{ const t = getPickers(); applyTheme(t); themeModal.classList.remove('open'); toast('Theme applied'); });
themeModal.addEventListener('click', (e)=>{ if (e.target === themeModal) themeModal.classList.remove('open'); });
themeModal.querySelectorAll('button[data-preset]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ const p = PRESETS[btn.dataset.preset]; applyTheme(p); syncPickers(p); toast('Preset applied'); });
});
loadTheme();

/* === Load tracks === */
async function loadTracks(){
  const { data, error } = await sb.from('tracks').select('*').order('created_at', { ascending:false }).limit(500);
  if (error) { toast('Load failed'); console.error(error); return; }
  TRACKS = data || [];
  render();
}
loadTracks();
setInterval(loadTracks, 4000);

/* === Render grid === */
function render(){
  const q = FILTER.trim().toLowerCase();
  const items = !q ? TRACKS : TRACKS.filter(t =>
    (t.title||'').toLowerCase().includes(q) || (t.artist||'').toLowerCase().includes(q)
  );
  grid.innerHTML = items.map(t => `
    <article class="card" data-id="${t.id}">
      <img class="thumb" alt="" src="${t.thumbnail_url || placeholder(t.title,t.artist)}">
      <div class="meta">
        <p class="title" title="${esc(t.title)}">${esc(t.title)}</p>
        <p class="artist" title="${esc(t.artist)}">${esc(t.artist)}</p>
        <div class="row-tight">
          <button class="btn play" data-id="${t.id}">Play</button>
          <button class="btn ghost comments" data-id="${t.id}">Comments</button>
          ${ADMIN_ENABLED ? `<button class="btn danger del" data-id="${t.id}">Delete</button>` : ''}
        </div>
      </div>
    </article>
  `).join('') || `<p style="color:var(--accent-2);padding:18px">No tracks yet. Unlock admin and upload one.</p>`;
}
grid.addEventListener('click', async (e)=>{
  const pid = e.target.closest('.play')?.dataset.id;
  const cid = e.target.closest('.comments')?.dataset.id;
  const did = e.target.closest('.del')?.dataset.id;
  if (pid) playById(pid);
  if (cid) openComments(cid);
  if (did) deleteTrack(did);
});
search.addEventListener('input', ()=>{ FILTER = search.value; render(); });

/* === Player === */
async function playById(id){
  const t = TRACKS.find(x=>x.id===id); if(!t) return;
  currentTrack = t;
  audio.src = t.audio_url;
  pthumb.src = t.thumbnail_url || placeholder(t.title,t.artist);
  ptitle.textContent = t.title || 'Untitled';
  partist.textContent = t.artist || 'Unknown';
  audio.play().catch(()=>{});
  playBtn.textContent='Pause';
}
playBtn.addEventListener('click', ()=>{
  if(!audio.src){
    const f=TRACKS[0]; if(f) playById(f.id);
    return;
  }
  if (audio.paused) audio.play(); else audio.pause();
});
audio.addEventListener('play', ()=> playBtn.textContent='Pause');
audio.addEventListener('pause', ()=> playBtn.textContent='Play');
audio.addEventListener('loadedmetadata', ()=>{
  seek.max=Math.max(1,Math.floor(audio.duration||0));
  durEl.textContent=fmt(audio.duration||0);
});
audio.addEventListener('timeupdate', ()=>{
  if(!seeking) seek.value=Math.floor(audio.currentTime);
  curTimeEl.textContent=fmt(audio.currentTime);
});
seek.addEventListener('input', ()=> seeking=true);
seek.addEventListener('change', ()=>{ audio.currentTime=+seek.value; seeking=false; });
vol.addEventListener('input', ()=> audio.volume=+vol.value);

/* === Keyboard === */
window.addEventListener('keydown', e=>{
  if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if (e.code==='Space'){ e.preventDefault(); playBtn.click(); }
  if (e.code==='ArrowRight') audio.currentTime = Math.min(audio.duration||0, audio.currentTime + 5);
  if (e.code==='ArrowLeft')  audio.currentTime = Math.max(0, audio.currentTime - 5);
});

/* === Admin unlock === */
adminBtn.addEventListener('click', ()=>{ pwModal.classList.add('open'); pwInput.value=''; pwInput.focus(); });
cancelPw.addEventListener('click', ()=> pwModal.classList.remove('open'));
unlockBtn.addEventListener('click', ()=>{
  if(pwInput.value===PASSWORD){
    ADMIN_ENABLED=true;
    pwModal.classList.remove('open');
    uploadFab.style.display='inline-flex';
    statusPill.textContent='Admin';
    statusPill.style.background='#13130c'; statusPill.style.borderColor= '#2a2a1a'; statusPill.style.color='var(--accent-2)';
    toast('Admin unlocked');
    render();
  } else {
    toast('Wrong password');
  }
});
pwInput.addEventListener('keydown', e=>{ if(e.key==='Enter') unlockBtn.click(); });

/* === Upload flow === */
uploadFab.addEventListener('click', ()=> openUpload());
function openUpload(){ upModal.classList.add('open'); resetUploadUI(); }
cancelUpload.addEventListener('click', ()=> upModal.classList.remove('open'));
drop.addEventListener('click', ()=> audioInput.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', e=>{
  e.preventDefault(); drop.classList.remove('drag');
  const f = e.dataTransfer.files?.[0]; if (f) handleAudioFile(f);
});
audioInput.addEventListener('change', ()=> {
  const f = audioInput.files?.[0]; if (f) handleAudioFile(f);
});
thumbFileIn.addEventListener('change', async ()=>{
  const f = thumbFileIn.files?.[0]; if(!f) return;
  const url = await fileToDataURL(f); thumbUrlIn.value = url; toast('Thumbnail set');
});

let pendingAudio=null;
async function handleAudioFile(file){
  if (!/^audio\/(mpeg|wav)$/.test(file.type) && !/\.(mp3|wav)$/i.test(file.name)) { toast('Choose an MP3 or WAV'); return; }
  pendingAudio={ file, duration:0 };
  meta.textContent=`Selected: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
  prog.value=10;
  try{
    const url=URL.createObjectURL(file);
    const probe=new Audio(); probe.src=url; probe.preload='metadata';
    await new Promise((res,rej)=>{ probe.onloadedmetadata=()=>res(); probe.onerror=()=>rej(); });
    pendingAudio.duration=probe.duration|0; durProbe.textContent=`Duration ~ ${fmt(pendingAudio.duration)}`;
    URL.revokeObjectURL(url);
  }catch{}
  prog.value=20;
}

saveBtn.addEventListener('click', async ()=>{
  if(!ADMIN_ENABLED) return toast('Unlock admin first');
  if(!pendingAudio?.file) return toast('Add an MP3/WAV first');
  const title=titleIn.value.trim(), artist=artistIn.value.trim();
  if(!title||!artist) return toast('Title and Artist required');

  try{
    prog.value=35; meta.textContent='Uploading audio…';
    const id = 't_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
    const ext = /\.wav$/i.test(pendingAudio.file.name) ? 'wav' : 'mp3';
    const path = `audio/${id}.${ext}`;
    const up = await sb.storage.from('audio').upload(path, pendingAudio.file, { upsert:false });
    if (up.error) throw new Error('Storage upload: ' + up.error.message);
    const { data: urlData } = sb.storage.from('audio').getPublicUrl(path);
    const audioUrl = urlData.publicUrl;

    // Thumbnail
    let thumbnailUrl = '';
    const tIn = thumbUrlIn.value.trim();
    if (tIn.startsWith('http')) { thumbnailUrl = tIn; }
    else if (tIn.startsWith('data:')) {
      prog.value=55; meta.textContent='Uploading thumbnail…';
      const png = dataURLtoBlob(tIn);
      const upImg = await sb.storage.from('audio').upload(`thumbs/${id}.png`, png, { upsert:false, contentType:'image/png' });
      if (upImg.error) throw new Error('Thumb upload: ' + upImg.error.message);
      thumbnailUrl = sb.storage.from('audio').getPublicUrl(`thumbs/${id}.png`).data.publicUrl;
    }

    // Save row via password-checked RPC
    prog.value=75; meta.textContent='Saving metadata…';
    const rpc = await sb.rpc('upload_track', {
      pw_client: PASSWORD, p_id: id, p_title: title, p_artist: artist,
      p_audio_url: audioUrl, p_thumbnail_url: thumbnailUrl, p_duration: pendingAudio.duration|0
    });
    if (rpc.error) throw new Error('RPC upload_track: ' + rpc.error.message);

    prog.value=100; meta.textContent='Done!';
    resetUploadUI(true);
    toast('Track uploaded');
    loadTracks();
  }catch(err){
    console.error(err);
    toast(String(err.message || err));
  }
});

function resetUploadUI(clear=false){
  if(clear){
    titleIn.value=''; artistIn.value=''; thumbUrlIn.value=''; thumbFileIn.value=''; audioInput.value='';
    pendingAudio=null; durProbe.textContent='';
  }
  prog.value=0; meta.textContent='No file';
}

/* === Admin delete track === */
async function deleteTrack(id){
  if (!ADMIN_ENABLED) return toast('Unlock admin first');
  const t = TRACKS.find(x=>x.id===id);
  if (!t) return;
  if (!confirm(`Delete "${t.title}" by ${t.artist}?`)) return;
  try {
    const rpc = await sb.rpc('delete_track', { pw_client: PASSWORD, p_id: id });
    if (rpc.error) throw new Error('RPC delete_track: ' + rpc.error.message);
    // UI remove immediately
    const card = document.querySelector(`.card[data-id="${id}"]`);
    if (card) card.remove();
    TRACKS = TRACKS.filter(x => x.id !== id);
    toast('Deleted');
    // best-effort file cleanup
    await sb.storage.from('audio').remove([`audio/${id}.mp3`, `audio/${id}.wav`, `thumbs/${id}.png`]);
    loadTracks();
  } catch (err) {
    console.error(err);
    toast(String(err.message || err));
  }
}

/* === Comments === */
async function openComments(trackId){
  const t = TRACKS.find(x=>x.id===trackId); if (!t) return;
  currentTrack = t;
  cThumb.src = t.thumbnail_url || placeholder(t.title,t.artist);
  cTitle.textContent = t.title || 'Untitled';
  cArtist.textContent = t.artist || 'Unknown';
  cBody.value = ''; cName.value = '';
  cModal.classList.add('open');
  await loadComments(trackId);
  if (currentCommentsPoll) clearInterval(currentCommentsPoll);
  currentCommentsPoll = setInterval(()=>loadComments(trackId), 5000);
}
cClose.addEventListener('click', ()=>{ cModal.classList.remove('open'); if (currentCommentsPoll) clearInterval(currentCommentsPoll); });

async function loadComments(trackId){
  const { data, error } = await sb.from('comments').select('*').eq('track_id', trackId).order('created_at', { ascending:true });
  if (error) { console.error(error); return; }
  renderComments(data || []);
}
function renderComments(items){
  cList.innerHTML = items.map(c => `
    <div class="citem" data-cid="${c.id}">
      <div style="flex:1;min-width:0">
        <div class="cmeta">${esc(c.author||'Anon')} • ${new Date(c.created_at).toLocaleString()}</div>
        <div class="cbody">${esc(c.body)}</div>
      </div>
      ${ADMIN_ENABLED ? `<button class="btn danger cdel" data-cid="${c.id}">Delete</button>` : ''}
    </div>
  `).join('') || `<p class="muted">No comments yet. Be the first!</p>`;
}
cList.addEventListener('click', async (e)=>{
  const cid = e.target.closest('.cdel')?.dataset.cid;
  if (!cid) return;
  if (!ADMIN_ENABLED) return toast('Unlock admin first');
  if (!confirm('Delete this comment?')) return;
  try{
    const rpc = await sb.rpc('delete_comment', { pw_client: PASSWORD, p_comment_id: cid });
    if (rpc.error) throw new Error('RPC delete_comment: ' + rpc.error.message);
    toast('Comment deleted');
    loadComments(currentTrack.id);
  }catch(err){ console.error(err); toast(String(err.message||err)); }
});
cForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!currentTrack) return;
  const author = cName.value.trim() || null;
  const body = cBody.value.trim();
  if (!body) return;
  try{
    const { error } = await sb.from('comments').insert({ track_id: currentTrack.id, author, body });
    if (error) throw error;
    cBody.value=''; toast('Posted');
    loadComments(currentTrack.id);
  }catch(err){ console.error(err); toast('Could not post comment'); }
});

/* === Helpers === */
function toast(msg, ms=2200){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', ms); }
function fmt(s){ s=Math.max(0,s|0); const m=(s/60)|0, r=(s%60)|0; return m+':' + (r<10?'0':'')+r; }
function esc(s=''){ return s.replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[m])); }
function placeholder(title,artist){
  // Derive colors from current theme for the SVG
  const styles = getComputedStyle(document.documentElement);
  const c1 = styles.getPropertyValue('--bg').trim() || '#0b0b0b';
  const c2 = styles.getPropertyValue('--card').trim() || '#1a1a1a';
  const t1 = styles.getPropertyValue('--accent-2').trim() || '#fff08a';
  const t2 = styles.getPropertyValue('--accent').trim() || '#ffd400';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='640' height='400'>
    <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
      <stop offset='0%' stop-color='${c1}'/><stop offset='100%' stop-color='${c2}'/></linearGradient></defs>
    <rect width='100%' height='100%' fill='url(#g)'/>
    <text x='32' y='210' font-family='Inter,Segoe UI,Arial' font-size='38' fill='${t1}' font-weight='900'>${(title||'Untitled').slice(0,28)}</text>
    <text x='32' y='255' font-family='Inter,Segoe UI,Arial' font-size='22' fill='${t2}'>${(artist||'Unknown').slice(0,36)}</text>
  </svg>`;
  return 'data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(svg)));
}
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function dataURLtoBlob(dataURL){
  const [h,b] = dataURL.split(',');
  const mime = h.match(/:(.*?);/)[1];
  const bin = atob(b); const len = bin.length;
  const arr = new Uint8Array(len); for (let i=0;i<len;i++) arr[i]=bin.charCodeAt(i);
  return new Blob([arr], {type:mime});
}
</script>
</body>
</html>
