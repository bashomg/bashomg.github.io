<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wavee ‚Äî Global Music Library</title>
<style>
  :root{
    --bg:#070a0b; --bg2:#0b1113; --card:#0e1518; --text:#eaffff; --muted:#a7cbd1;
    --border:#122026; --accent:#1dd2c3; --accent-2:#8ff1e9; --ring:rgba(29,210,195,.28);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font:15px/1.5 system-ui,Segoe UI,Inter,Arial;transition:filter 2s ease}
  header{position:sticky;top:0;z-index:10;background:#060a0de6;padding:10px 12px;border-bottom:1px solid var(--border);backdrop-filter:blur(10px)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .logo{height:28px;border-radius:6px;border:1px solid var(--border);background:#000}
  .input{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0a1214;color:var(--text);outline:none}
  .input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--ring)}
  .btn{background:#0f181b;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn:hover{border-color:#1c2d34}
  .btn.primary{background:var(--accent);border-color:transparent;color:#042f2c;font-weight:800}
  .btn.ghost{background:transparent;border-color:#1b2a30}
  .btn.danger{background:transparent;border-color:var(--accent);color:var(--accent);font-weight:800}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#0c1619;border:1px solid var(--border);color:var(--muted)}
  .grid{display:grid;gap:14px;padding:14px 16px 140px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
  .thumb{width:100%;aspect-ratio:1.6/1;object-fit:cover;background:#0e1518}
  .meta{padding:10px 12px}
  .title{font-weight:900;font-size:14px;margin:0 0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .artist{color:var(--muted);font-size:12px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row-tight{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .hr{height:1px;background:var(--border);margin:10px 0}

  /* Player */
  .player{position:fixed;left:0;right:0;bottom:0;background:#081114;border-top:1px solid var(--border);display:flex;gap:10px;padding:10px 14px;align-items:center}
  .pthumb{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#0a1316;border:1px solid var(--border)}
  .time{font-variant-numeric:tabular-nums;font-size:12px;color:var(--accent-2)}
  input[type="range"]{accent-color:var(--accent)}

  /* Modals */
  .modal{position:fixed;inset:0;display:none;place-items:center;z-index:60}
  .modal.open{display:grid}
  .panel{width:min(900px,96vw);background:#0c1316;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 30px 80px rgba(0,0,0,.6)}
  .muted{color:var(--muted);font-size:13px;margin:6px 0 0}
  .drop{border:1.5px dashed #1d2b31;border-radius:14px;padding:14px;text-align:center;background:#0b1214;margin-top:8px}
  .drop.drag{border-color:var(--accent);background:#0b1416}

  /* Comments */
  .c-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .c-head img{width:48px;height:48px;border-radius:8px;border:1px solid var(--border);object-fit:cover}
  .c-title{font-weight:900;margin:0}
  .c-artist{margin:0;color:var(--muted);font-size:13px}
  .clist{display:flex;flex-direction:column;gap:10px;max-height:50vh;overflow:auto;margin:10px 0}
  .citem{display:flex;gap:10px;background:#0e1619;border:1px solid var(--border);padding:10px;border-radius:12px}
  .cmeta{color:var(--accent);font-size:12px}
  .cbody{margin:2px 0 0}

  /* Startup screen */
  #start{position:fixed;inset:0;background:
    radial-gradient(1200px 600px at 20% 20%, rgba(29,210,195,.10), transparent 60%),
    radial-gradient(900px 600px at 80% 70%, rgba(143,241,233,.08), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2)); display:grid;place-items:center;z-index:100}
  .start-wrap{max-width:980px;width:94vw}
  .hero{display:grid;grid-template-columns:1.2fr 1fr;gap:20px;align-items:center}
  .heroCard{background:#0a1113d9;border:1px solid var(--border);padding:18px;border-radius:16px}
  .big{font-size:36px;line-height:1.15;margin:0 0 10px;font-weight:900;letter-spacing:.2px}
  .pulse{animation:pulse 2.2s ease-in-out infinite}
  @keyframes pulse{0%{filter:brightness(1)}50%{filter:brightness(1.12)}100%{filter:brightness(1)}}

  /* Playlists */
  .plist{display:flex;flex-direction:column;gap:8px;max-height:45vh;overflow:auto;margin-top:10px}
  .pli{display:flex;align-items:center;justify-content:space-between;background:#0f181b;border:1px solid var(--border);padding:10px;border-radius:10px}
  .pli small{color:var(--muted)}

  /* Theme Library */
  .tabs{display:flex;gap:6px;margin:6px 0 10px}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0f181b;cursor:pointer}
  .tab.active{outline:2px solid var(--accent)}
  .themeGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .tcard{background:#0f181b;border:1px solid var(--border);padding:10px;border-radius:12px}
  .sw{width:20px;height:20px;border-radius:6px;border:1px solid var(--border);display:inline-block;margin-right:4px}

  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0c1316;color:#cffff7;border:1px solid #1a2a30;padding:10px 14px;border-radius:12px;display:none;z-index:120}
  .adminFab{position:fixed;right:16px;bottom:90px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:50}
</style>
</head>
<body>
  <header>
    <div class="row">
      <img class="logo" src="https://raw.githubusercontent.com/bashomg/bashomg.github.io/refs/heads/main/WaveeLogo.png" alt="Wavee Logo">
      <input id="search" class="input" placeholder="Search title or artist‚Ä¶"/>
      <span id="status" class="pill">Guest</span>
      <button id="playlistsBtn" class="btn">Playlists</button>
      <button id="themeBtn" class="btn">Themes</button>
      <button id="adminBtn" class="btn primary">Admin</button>
      <button id="authBtn" class="btn">Login</button>
      <button id="logoutBtn" class="btn" style="display:none">Logout</button>
    </div>
  </header>

  <main id="grid" class="grid" aria-live="polite"></main>

  <!-- Player -->
  <div class="player" aria-label="Player">
    <img id="pthumb" class="pthumb" alt="">
    <div style="min-width:0;display:flex;flex-direction:column">
      <p id="ptitle" style="margin:0;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Nothing playing</p>
      <p id="partist" style="margin:0;color:var(--accent-2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">‚Äî</p>
    </div>
    <button id="playPause" class="btn">Play</button>
    <button id="addToPl" class="btn ghost">Add to Playlist</button>
    <span id="curTime" class="time">0:00</span>
    <input id="seek" type="range" min="0" max="100" value="0" style="flex:1"/>
    <span id="dur" class="time">0:00</span>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:110px">
  </div>

  <!-- Startup overlay -->
  <section id="start">
    <div class="start-wrap">
      <div class="hero">
        <div class="heroCard">
          <p class="big pulse">Your music, your rules. Upload, share, and build playlists.</p>
          <p class="muted">Log in to create playlists and upload tracks. Admins can moderate any content. All audio is public.</p>
          <ul>
            <li>üéß Global library (teal & black)</li>
            <li>üóÇÔ∏è Personal playlists</li>
            <li>üí¨ Comments on tracks</li>
            <li>üõ°Ô∏è Owner delete; admin override</li>
          </ul>
        </div>
        <div class="heroCard">
          <h3 style="margin-top:0">Login or Create Account</h3>
          <div class="row" style="margin-top:8px"><input id="email" class="input" type="email" placeholder="Email" style="flex:1"></div>
          <div class="row" style="margin-top:8px"><input id="password" class="input" type="password" placeholder="Password (min 6)" style="flex:1"></div>
          <div class="row" style="margin-top:10px">
            <button id="doLogin" class="btn primary">Login</button>
            <button id="doSignup" class="btn">Create Account</button>
            <button id="continueGuest" class="btn ghost">Continue as Guest</button>
          </div>
          <p class="muted" style="margin-top:10px">Tip: After login, use <strong>Admin</strong> to unlock moderator tools with the password.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin password -->
  <div id="pwModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Unlock Admin</h3>
      <p class="muted">Admins can delete any song or comment.</p>
      <div class="row" style="margin-top:10px">
        <input id="pw" type="password" class="input" placeholder="Password" style="flex:1">
        <button id="unlock" class="btn primary">Unlock</button>
        <button id="cancelPw" class="btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Upload -->
  <div id="upModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Upload Track</h3>
      <div id="drop" class="drop">Drop .mp3/.wav here or click to choose</div>
      <input id="audioInput" type="file" accept=".mp3,.wav,audio/mpeg,audio/wav" hidden>
      <div class="row" style="margin-top:10px">
        <input id="titleIn" class="input" placeholder="Title *" style="flex:1">
        <input id="artistIn" class="input" placeholder="Artist *" style="flex:1">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="thumbUrlIn" class="input" placeholder="Thumbnail URL (optional)" style="flex:1">
        <label class="btn">Choose Image<input id="thumbFileIn" type="file" accept="image/*" hidden></label>
      </div>
      <div class="row" style="margin-top:10px">
        <progress id="prog" max="100" value="0" style="width:220px;height:16px"></progress>
        <span id="meta" class="muted">No file</span>
        <span id="durProbe" class="muted"></span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="save" class="btn primary">Save</button>
        <button id="cancelUpload" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Comments -->
  <div id="cModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <div class="c-head">
        <img id="cThumb" alt="">
        <div style="flex:1;min-width:0">
          <p id="cTitle" class="c-title"></p>
          <p id="cArtist" class="c-artist"></p>
        </div>
        <button id="cClose" class="btn">Close</button>
      </div>
      <div id="cList" class="clist" aria-live="polite"></div>
      <form id="cForm" class="cform">
        <input id="cName" class="input" placeholder="Your name (optional)">
        <input id="cBody" class="input" placeholder="Write a comment‚Ä¶" maxlength="500" required>
        <button id="cPost" class="btn primary" type="submit">Post</button>
      </form>
    </div>
  </div>

  <!-- Playlists -->
  <div id="plModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Your Playlists</h3>
      <div class="row" style="margin-top:6px">
        <input id="plName" class="input" placeholder="New playlist name" style="flex:1">
        <button id="plCreate" class="btn primary">Create</button>
        <button id="plClose" class="btn">Close</button>
      </div>
      <div id="plList" class="plist"></div>
    </div>
  </div>

  <!-- Theme Library -->
  <div id="themeModal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h3>Theme Library</h3>
      <div class="tabs">
        <button class="tab active" data-tab="browse">Browse</button>
        <button class="tab" data-tab="create">Create</button>
        <button class="tab" data-tab="my">My Themes</button>
      </div>

      <div id="tab-browse">
        <div class="muted">Public themes shared by everyone.</div>
        <div id="themeGrid" class="themeGrid" style="margin-top:10px"></div>
      </div>

      <div id="tab-create" style="display:none">
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <input id="thName" class="input" placeholder="Theme name" style="flex:1;min-width:200px">
          <label class="btn ghost">Fade seconds <input id="fadeSeconds" type="number" min="5" max="60" value="10" style="width:80px;margin-left:8px"></label>
          <label class="btn ghost">Fade amount % <input id="fadeAmount" type="number" min="0" max="30" value="10" style="width:80px;margin-left:8px"></label>
        </div>
        <div class="row" style="margin-top:8px;flex-wrap:wrap">
          <label class="btn ghost">BG <input id="tBg" type="color" value="#070a0b" style="margin-left:8px"></label>
          <label class="btn ghost">BG 2 <input id="tBg2" type="color" value="#0b1113" style="margin-left:8px"></label>
          <label class="btn ghost">Card <input id="tCard" type="color" value="#0e1518" style="margin-left:8px"></label>
          <label class="btn ghost">Text <input id="tText" type="color" value="#eaffff" style="margin-left:8px"></label>
          <label class="btn ghost">Muted <input id="tMuted" type="color" value="#a7cbd1" style="margin-left:8px"></label>
          <label class="btn ghost">Border <input id="tBorder" type="color" value="#122026" style="margin-left:8px"></label>
          <label class="btn ghost">Accent <input id="tAccent" type="color" value="#1dd2c3" style="margin-left:8px"></label>
          <label class="btn ghost">Accent 2 <input id="tAccent2" type="color" value="#8ff1e9" style="margin-left:8px"></label>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="thPreview" class="btn">Preview</button>
          <button id="thSaveLocal" class="btn">Save on this device</button>
          <button id="thPublish" class="btn primary">Publish (public)</button>
          <button id="themeClose" class="btn">Close</button>
        </div>
      </div>

      <div id="tab-my" style="display:none">
        <div class="muted">Your themes.</div>
        <div id="myThemeGrid" class="themeGrid" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <button id="uploadFab" class="btn primary adminFab" style="display:none">Upload</button>
  <div id="toast" class="toast"></div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
/* === CONFIG === */
const SUPABASE_URL = "https://hjcufpeuyoupaxkqwwnz.supabase.co";
const SUPABASE_ANON = "sb_publishable_XhQqm90hkkeNLbsv2R33nw_XQZ61S7w";
const PASSWORD = "intelz";
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

/* === UI refs === */
const $ = s => document.querySelector(s);
const grid = $('#grid'), search = $('#search'), statusPill = $('#status');
const adminBtn = $('#adminBtn'), authBtn = $('#authBtn'), logoutBtn = $('#logoutBtn');
const playlistsBtn = $('#playlistsBtn'), plModal = $('#plModal'), plName = $('#plName'), plCreate = $('#plCreate'), plList = $('#plList'), plClose = $('#plClose');

const themeBtn = $('#themeBtn'), themeModal = $('#themeModal');
const tabBtns = () => themeModal.querySelectorAll('.tab');
const tabBrowse = $('#tab-browse'), tabCreate = $('#tab-create'), tabMy = $('#tab-my');
const themeGrid = $('#themeGrid'), myThemeGrid = $('#myThemeGrid');

const thName = $('#thName');
const tBg = $('#tBg'), tBg2 = $('#tBg2'), tCard = $('#tCard'), tText = $('#tText'), tMuted = $('#tMuted'), tBorder = $('#tBorder'), tAccent = $('#tAccent'), tAccent2 = $('#tAccent2');
const fadeSeconds = $('#fadeSeconds'), fadeAmount = $('#fadeAmount');
const thPreview = $('#thPreview'), thSaveLocal = $('#thSaveLocal'), thPublish = $('#thPublish'); 

const start = $('#start'), emailIn = $('#email'), pwIn = $('#password'), doLogin = $('#doLogin'), doSignup = $('#doSignup'), continueGuest = $('#continueGuest');

const pwModal = $('#pwModal'), upModal = $('#upModal'), cModal = $('#cModal');
const pwInput = $('#pw'), unlockBtn = $('#unlock'), cancelPw = $('#cancelPw');

const drop = $('#drop'), audioInput = $('#audioInput');
const titleIn = $('#titleIn'), artistIn = $('#artistIn');
const thumbUrlIn = $('#thumbUrlIn'), thumbFileIn = $('#thumbFileIn');
const prog = $('#prog'), meta = $('#meta'), durProbe = $('#durProbe');
const saveBtn = $('#save'), cancelUpload = $('#cancelUpload');

const toastEl = $('#toast');
const playBtn = $('#playPause'), seek = $('#seek'), vol = $('#vol'), addToPl = $('#addToPl');
const curTimeEl = $('#curTime'), durEl = $('#dur');
const pthumb = $('#pthumb'), ptitle = $('#ptitle'), partist = $('#partist');

const cThumb = $('#cThumb'), cTitle = $('#cTitle'), cArtist = $('#cArtist');
const cList = $('#cList'), cForm = $('#cForm'), cName = $('#cName'), cBody = $('#cBody'), cClose = $('#cClose');

/* === State === */
let ADMIN_ENABLED = false;
let TRACKS = [];
let FILTER = '';
let seeking=false;
let currentTrack = null;
let currentCommentsPoll = null;
let user = null;
const audio = new Audio(); audio.preload='metadata'; audio.crossOrigin='anonymous'; vol.value=1;

/* === STARTUP BACKGROUND MUSIC === */
const BGM_URL = "https://bashomg.github.io/waveeAmb.mp3";
const bgm = new Audio(BGM_URL); bgm.loop = true; bgm.volume = 0.05; bgm.preload = 'auto';
function tryPlayBgm(){ bgm.play().catch(()=>{}); }
document.addEventListener('DOMContentLoaded', tryPlayBgm);
if (start) { const unlockBgm = () => { try{ bgm.volume=0.05; bgm.play(); }catch{} start.removeEventListener('pointerdown', unlockBgm); }; start.addEventListener('pointerdown', unlockBgm); }
function stopBgm(){ try { bgm.pause(); bgm.currentTime = 0; } catch {} }

/* === Dynamic fading background === */
let fadeTimer=null, fadeTick=0;
function applyFadeTimer(){
  if (fadeTimer) clearInterval(fadeTimer);
  const seconds = Number(localStorage.getItem('wavee_fade_seconds')||10);
  const amountPct = Number(localStorage.getItem('wavee_fade_amount')||10);
  fadeTick = 0;
  fadeTimer = setInterval(()=>{
    fadeTick = (fadeTick + 1) % 6;
    const factor = 1 + (amountPct/100) * (fadeTick/5);
    document.body.style.filter = `brightness(${1/factor})`;
  }, Math.max(5, seconds)*1000);
}
applyFadeTimer();

/* === Auth === */
async function refreshUser(){
  const { data: { user: u } } = await sb.auth.getUser();
  user = u || null;
  statusPill.textContent = user ? (user.email || 'User') : 'Guest';
  authBtn.style.display = user ? 'none' : 'inline-flex';
  logoutBtn.style.display = user ? 'inline-flex' : 'none';
  uploadFab.style.display = user ? 'inline-flex' : (ADMIN_ENABLED?'inline-flex':'none');
  render();
}
doLogin.addEventListener('click', async ()=>{
  try{
    const { error } = await sb.auth.signInWithPassword({ email: emailIn.value.trim(), password: pwIn.value });
    if (error) throw error;
    start.style.display='none'; stopBgm(); toast('Welcome back!'); refreshUser();
  }catch(e){ toast('Login failed: '+e.message); }
});
doSignup.addEventListener('click', async ()=>{
  try{
    const { error } = await sb.auth.signUp({ email: emailIn.value.trim(), password: pwIn.value });
    if (error) throw error;
    start.style.display='none'; stopBgm(); toast('Account created!'); refreshUser();
  }catch(e){ toast('Signup failed: '+e.message); }
});
continueGuest.addEventListener('click', ()=>{ start.style.display='none'; stopBgm(); toast('Browsing as guest'); });
authBtn.addEventListener('click', ()=>{ start.style.display='grid'; tryPlayBgm(); });
logoutBtn.addEventListener('click', async ()=>{ await sb.auth.signOut(); ADMIN_ENABLED=false; statusPill.textContent='Guest'; uploadFab.style.display='none'; toast('Logged out'); refreshUser(); });

/* Admin unlock */
adminBtn.addEventListener('click', ()=>{ pwModal.classList.add('open'); pwInput.value=''; pwInput.focus(); });
cancelPw.addEventListener('click', ()=> pwModal.classList.remove('open'));
unlockBtn.addEventListener('click', ()=>{
  if(pwInput.value===PASSWORD){
    ADMIN_ENABLED=true;
    pwModal.classList.remove('open');
    uploadFab.style.display='inline-flex';
    statusPill.textContent = (user?'Admin ‚Ä¢ '+(user.email||'user'):'Admin');
    toast('Admin unlocked'); render();
  } else { toast('Wrong password'); }
});

/* Tracks */
async function loadTracks(){
  const { data, error } = await sb.from('tracks').select('*').order('created_at',{ascending:false}).limit(500);
  if (error) { console.error(error); return; }
  TRACKS = data || []; render();
}
loadTracks(); setInterval(loadTracks, 5000);

function canDeleteTrack(t){ if (ADMIN_ENABLED) return true; if (!user) return false; return t.owner_uid && t.owner_uid === user.id; }

/* Render */
function render(){
  const q = FILTER.trim().toLowerCase();
  const items = !q ? TRACKS : TRACKS.filter(t => (t.title||'').toLowerCase().includes(q) || (t.artist||'').toLowerCase().includes(q));
  grid.innerHTML = items.map(t => `
    <article class="card" data-id="${t.id}">
      <img class="thumb" alt="" src="${t.thumbnail_url || placeholder(t.title,t.artist)}">
      <div class="meta">
        <p class="title" title="${esc(t.title)}">${esc(t.title)}</p>
        <p class="artist" title="${esc(t.artist)}">${esc(t.artist)}</p>
        <div class="row-tight">
          <button class="btn play" data-id="${t.id}">Play</button>
          <button class="btn ghost comments" data-id="${t.id}">Comments</button>
          ${user ? `<button class="btn ghost addpl" data-id="${t.id}">Add to Playlist</button>` : ''}
          ${canDeleteTrack(t) ? `<button class="btn danger del" data-id="${t.id}">Delete</button>` : ''}
        </div>
      </div>
    </article>
  `).join('') || `<p style="color:var(--accent-2);padding:18px">No tracks yet. Login to upload the first one.</p>`;
}
grid.addEventListener('click', async (e)=>{
  const pid = e.target.closest('.play')?.dataset.id;
  const cid = e.target.closest('.comments')?.dataset.id;
  const did = e.target.closest('.del')?.dataset.id;
  const aid = e.target.closest('.addpl')?.dataset.id;
  if (pid) playById(pid);
  if (cid) openComments(cid);
  if (did) deleteTrack(did);
  if (aid) { currentTrack = TRACKS.find(x=>x.id===aid); openPlaylists(); }
});
search.addEventListener('input', ()=>{ FILTER = search.value; render(); });

/* Player */
async function playById(id){
  const t = TRACKS.find(x=>x.id===id); if(!t) return;
  currentTrack = t;
  audio.src = t.audio_url;
  pthumb.src = t.thumbnail_url || placeholder(t.title,t.artist);
  ptitle.textContent = t.title || 'Untitled';
  partist.textContent = t.artist || 'Unknown';
  audio.play().catch(()=>{}); playBtn.textContent='Pause';
}
playBtn.addEventListener('click', ()=>{
  if(!audio.src){ const f=TRACKS[0]; if(f) playById(f.id); return; }
  if (audio.paused) audio.play(); else audio.pause();
});
audio.addEventListener('play', ()=> playBtn.textContent='Pause');
audio.addEventListener('pause', ()=> playBtn.textContent='Play');
audio.addEventListener('loadedmetadata', ()=>{ seek.max=Math.max(1,Math.floor(audio.duration||0)); durEl.textContent=fmt(audio.duration||0); });
audio.addEventListener('timeupdate', ()=>{ if(!seeking) seek.value=Math.floor(audio.currentTime); curTimeEl.textContent=fmt(audio.currentTime); });
seek.addEventListener('input', ()=> seeking=true);
seek.addEventListener('change', ()=>{ audio.currentTime=+seek.value; seeking=false; });
vol.addEventListener('input', ()=> audio.volume=+vol.value);
addToPl.addEventListener('click', ()=>{ if(!user) return toast('Login to use playlists'); if(!currentTrack) return toast('Play a track first'); openPlaylists(); });

/* Upload */
const uploadFab = $('#uploadFab');
uploadFab.addEventListener('click', ()=>{ if(!user) return toast('Login first'); openUpload(); });
function openUpload(){ upModal.classList.add('open'); resetUploadUI(); }
cancelUpload.addEventListener('click', ()=> upModal.classList.remove('open'));
drop.addEventListener('click', ()=> audioInput.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('drag'); const f=e.dataTransfer.files?.[0]; if(f) handleAudioFile(f); });
audioInput.addEventListener('change', ()=>{ const f=audioInput.files?.[0]; if(f) handleAudioFile(f); });
thumbFileIn.addEventListener('change', async ()=>{ const f=thumbFileIn.files?.[0]; if(!f) return; const url = await fileToDataURL(f); thumbUrlIn.value=url; toast('Thumbnail set'); });

let pendingAudio=null;
async function handleAudioFile(file){
  if (!/^audio\/(mpeg|wav)$/.test(file.type) && !/\.(mp3|wav)$/i.test(file.name)) { toast('Choose an MP3 or WAV'); return; }
  pendingAudio={ file, duration:0 }; meta.textContent=`Selected: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`; prog.value=10;
  try{ const url=URL.createObjectURL(file); const probe=new Audio(); probe.src=url; probe.preload='metadata';
    await new Promise((res,rej)=>{ probe.onloadedmetadata=()=>res(); probe.onerror=()=>rej(); });
    pendingAudio.duration=probe.duration|0; durProbe.textContent=`Duration ~ ${fmt(pendingAudio.duration)}`; URL.revokeObjectURL(url);
  }catch{} prog.value=20;
}
saveBtn.addEventListener('click', async ()=>{
  if(!user) return toast('Login first');
  if(!pendingAudio?.file) return toast('Add an MP3/WAV first');
  const title=titleIn.value.trim(), artist=artistIn.value.trim(); if(!title||!artist) return toast('Title and Artist required');

  try{
    prog.value=35; meta.textContent='Uploading audio‚Ä¶';
    const id = 't_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
    const ext = /\.wav$/i.test(pendingAudio.file.name) ? 'wav' : 'mp3';
    const path = `audio/${id}.${ext}`;
    const up = await sb.storage.from('audio').upload(path, pendingAudio.file, { upsert:false });
    if (up.error) throw new Error('Storage upload: ' + up.error.message);
    const { data: urlData } = sb.storage.from('audio').getPublicUrl(path);
    const audioUrl = urlData.publicUrl;

    let thumbnailUrl = '';
    const tIn = thumbUrlIn.value.trim();
    if (tIn.startsWith('http')) thumbnailUrl = tIn;
    else if (tIn.startsWith('data:')) {
      prog.value=55; meta.textContent='Uploading thumbnail‚Ä¶';
      const png = dataURLtoBlob(tIn);
      const upImg = await sb.storage.from('audio').upload(`thumbs/${id}.png`, png, { upsert:false, contentType:'image/png' });
      if (upImg.error) throw new Error('Thumb upload: ' + upImg.error.message);
      thumbnailUrl = sb.storage.from('audio').getPublicUrl(`thumbs/${id}.png`).data.publicUrl;
    }

    prog.value=75; meta.textContent='Saving metadata‚Ä¶';
    const ins = await sb.from('tracks').insert({
      id, title, artist, audio_url: audioUrl, thumbnail_url: thumbnailUrl, duration: pendingAudio.duration|0, owner_uid: user.id
    }).select().single();
    if (ins.error) throw new Error('Insert track: ' + ins.error.message);

    prog.value=100; meta.textContent='Done!';
    resetUploadUI(true); toast('Track uploaded'); loadTracks();
  }catch(err){ console.error(err); toast(String(err.message||err)); }
});
function resetUploadUI(clear=false){
  if(clear){ titleIn.value=''; artistIn.value=''; thumbUrlIn.value=''; thumbFileIn.value=''; audioInput.value=''; pendingAudio=null; durProbe.textContent=''; }
  prog.value=0; meta.textContent='No file';
}

/* Delete track */
async function deleteTrack(id){
  const t = TRACKS.find(x=>x.id===id); if (!t) return;
  if (!(ADMIN_ENABLED || (user && t.owner_uid===user.id))) return toast('No permission');
  if (!confirm(`Delete "${t.title}" by ${t.artist}?`)) return;
  try{
    if (ADMIN_ENABLED){
      const rpc = await sb.rpc('delete_track', { pw_client: PASSWORD, p_id: id });
      if (rpc.error) throw new Error('RPC delete_track: ' + rpc.error.message);
    } else {
      const del = await sb.from('tracks').delete().eq('id', id);
      if (del.error) throw new Error('Delete track: ' + del.error.message);
    }
    const card = document.querySelector(`.card[data-id="${id}"]`); if (card) card.remove();
    TRACKS = TRACKS.filter(x=>x.id!==id); toast('Deleted');
    await sb.storage.from('audio').remove([`audio/${id}.mp3`,`audio/${id}.wav`,`thumbs/${id}.png`]);
    loadTracks();
  }catch(err){ console.error(err); toast(String(err.message||err)); }
}

/* Comments */
async function openComments(trackId){
  const t = TRACKS.find(x=>x.id===trackId); if (!t) return;
  currentTrack = t;
  cThumb.src = t.thumbnail_url || placeholder(t.title,t.artist);
  cTitle.textContent = t.title || 'Untitled';
  cArtist.textContent = t.artist || 'Unknown';
  cBody.value = ''; cName.value = '';
  cModal.classList.add('open');
  await loadComments(trackId);
  if (currentCommentsPoll) clearInterval(currentCommentsPoll);
  currentCommentsPoll = setInterval(()=>loadComments(trackId), 5000);
}
cClose.addEventListener('click', ()=>{ cModal.classList.remove('open'); if (currentCommentsPoll) clearInterval(currentCommentsPoll); });
async function loadComments(trackId){
  const { data, error } = await sb.from('comments').select('*').eq('track_id', trackId).order('created_at',{ascending:true});
  if (error) { console.error(error); return; }
  cList.innerHTML = (data||[]).map(c => `
    <div class="citem" data-cid="${c.id}">
      <div style="flex:1;min-width:0">
        <div class="cmeta">${esc(c.author||'Anon')} ‚Ä¢ ${new Date(c.created_at).toLocaleString()}</div>
        <div class="cbody">${esc(c.body)}</div>
      </div>
      ${ADMIN_ENABLED ? `<button class="btn danger cdel" data-cid="${c.id}">Delete</button>` : ''}
    </div>
  `).join('') || `<p class="muted">No comments yet. Be the first!</p>`;
}
cList.addEventListener('click', async (e)=>{
  const cid = e.target.closest('.cdel')?.dataset.cid; if (!cid) return;
  if (!ADMIN_ENABLED) return toast('Admin only');
  if (!confirm('Delete this comment?')) return;
  try{ const rpc = await sb.rpc('delete_comment', { pw_client: PASSWORD, p_comment_id: cid }); if (rpc.error) throw new Error(rpc.error.message); toast('Comment deleted'); loadComments(currentTrack.id); }
  catch(err){ console.error(err); toast(String(err.message||err)); }
});
cForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!currentTrack) return;
  const author = cName.value.trim() || (user?.email || null);
  const body = cBody.value.trim(); if (!body) return;
  try{ const { error } = await sb.from('comments').insert({ track_id: currentTrack.id, author, body }); if (error) throw error; cBody.value=''; toast('Posted'); loadComments(currentTrack.id); }
  catch(err){ console.error(err); toast('Could not post comment'); }
});

/* Playlists */
playlistsBtn.addEventListener('click', ()=> openPlaylists());
plClose.addEventListener('click', ()=> plModal.classList.remove('open'));
plCreate.addEventListener('click', async ()=>{
  if (!user) return toast('Login first');
  const name = plName.value.trim(); if (!name) return;
  try{ const ins = await sb.from('playlists').insert({ name, owner_uid: user.id }).select().single(); if (ins.error) throw ins.error; plName.value=''; toast('Playlist created'); loadPlaylists(); }
  catch(err){ console.error(err); toast('Create failed'); }
});
async function openPlaylists(){ if (!user){ toast('Login first'); return; } plModal.classList.add('open'); await loadPlaylists(); }
async function loadPlaylists(){
  const { data, error } = await sb.from('playlists').select('id,name,created_at').eq('owner_uid', user.id).order('created_at',{ascending:false});
  if (error){ console.error(error); return; }
  const items = data||[];
  plList.innerHTML = items.map(p=>`
    <div class="pli" data-pl="${p.id}">
      <div><strong>${esc(p.name)}</strong><br><small>${new Date(p.created_at).toLocaleString()}</small></div>
      <div class="row">
        ${currentTrack ? `<button class="btn ghost addcur" data-pl="${p.id}">Add current</button>` : ''}
        <button class="btn ghost viewpl" data-pl="${p.id}">Open</button>
        <button class="btn danger delpl" data-pl="${p.id}">Delete</button>
      </div>
    </div>
  `).join('') || `<p class="muted">No playlists yet. Create one above.</p>`;
}
plList.addEventListener('click', async (e)=>{
  const plId = e.target.closest('.addcur')?.dataset.pl || e.target.closest('.viewpl')?.dataset.pl || e.target.closest('.delpl')?.dataset.pl;
  if (!plId) return;
  if (e.target.closest('.addcur')){
    if (!currentTrack) return; 
    try{ const ins = await sb.from('playlist_items').insert({ playlist_id: plId, track_id: currentTrack.id }); if (ins.error) throw ins.error; toast('Added to playlist'); }
    catch(err){ console.error(err); toast('Add failed'); }
  } else if (e.target.closest('.viewpl')){
    try{
      const { data, error } = await sb.from('playlist_items').select('track_id, tracks(*)').eq('playlist_id', plId).order('added_at',{ascending:true});
      if (error) throw error;
      const rows = data||[];
      TRACKS = rows.map(r=>r.tracks).filter(Boolean);
      render(); plModal.classList.remove('open'); toast('Viewing playlist');
    }catch(err){ console.error(err); toast('Open failed'); }
  } else if (e.target.closest('.delpl')){
    if (!confirm('Delete this playlist?')) return;
    try{ const del = await sb.from('playlists').delete().eq('id', plId); if (del.error) throw del.error; toast('Playlist deleted'); loadPlaylists(); }
    catch(err){ console.error(err); toast('Delete failed'); }
  }
});

/* === THEME LIBRARY === */
themeBtn.addEventListener('click', ()=>{ themeModal.classList.add('open'); loadPublicThemes(); loadMyThemes(); });
themeModal.addEventListener('click', (e)=>{ if (e.target===themeModal) themeModal.classList.remove('open'); });

tabBtns().forEach(b=>b.addEventListener('click',()=>{
  tabBtns().forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  const name = b.dataset.tab;
  tabBrowse.style.display = name==='browse'?'block':'none';
  tabCreate.style.display = name==='create'?'block':'none';
  tabMy.style.display = name==='my'?'block':'none';
}));

function themeVarsFromInputs(){
  return {
    bg:tBg.value, bg2:tBg2.value, card:tCard.value, text:tText.value, muted:tMuted.value,
    border:tBorder.value, accent:tAccent.value, accent2:tAccent2.value,
    fade_amount: Number(fadeAmount.value||10), fade_seconds: Number(fadeSeconds.value||10)
  };
}
function applyTheme(vars){
  const root = document.documentElement.style;
  root.setProperty('--bg', vars.bg); root.setProperty('--bg2', vars.bg2); root.setProperty('--card', vars.card);
  root.setProperty('--text', vars.text); root.setProperty('--muted', vars.muted); root.setProperty('--border', vars.border);
  root.setProperty('--accent', vars.accent); root.setProperty('--accent-2', vars.accent2);
  root.setProperty('--ring', hexToRgba(vars.accent, .28));
  localStorage.setItem('wavee_theme', JSON.stringify(vars));
  localStorage.setItem('wavee_fade_seconds', String(vars.fade_seconds||10));
  localStorage.setItem('wavee_fade_amount', String(vars.fade_amount||10));
  applyFadeTimer();
  toast('Theme applied');
}
function loadLocalTheme(){ const raw = localStorage.getItem('wavee_theme'); if(!raw) return; try{ applyTheme(JSON.parse(raw)); }catch{} }
loadLocalTheme();

thPreview.addEventListener('click', ()=> applyTheme(themeVarsFromInputs()));
thSaveLocal.addEventListener('click', ()=>{ const v=themeVarsFromInputs(); localStorage.setItem('wavee_theme', JSON.stringify(v)); localStorage.setItem('wavee_fade_seconds', v.fade_seconds); localStorage.setItem('wavee_fade_amount', v.fade_amount); applyTheme(v); });
thPublish.addEventListener('click', async ()=>{
  if (!user) return toast('Login to publish');
  const name = thName.value.trim(); if (!name) return toast('Name your theme');
  const vars = themeVarsFromInputs();
  try{
    const ins = await sb.from('themes').insert({ owner_uid: user.id, name, vars, is_public: true }).select().single();
    if (ins.error) throw ins.error;
    toast('Theme published'); loadPublicThemes(); loadMyThemes();
  }catch(err){ console.error(err); toast('Publish failed'); }
});

function themeCard(row, mine){
  const v = row.vars||{};
  const vars64 = btoa(JSON.stringify(v));
  const showDelete = mine || ADMIN_ENABLED;
  return `
    <div class="tcard" data-id="${row.id}" data-vars="${vars64}">
      <div class="row" style="justify-content:space-between">
        <strong>${esc(row.name||'Untitled')}</strong>
        <small class="muted">${new Date(row.created_at).toLocaleDateString()}</small>
      </div>
      <div class="hr"></div>
      <div>
        <span class="sw" style="background:${v.bg}"></span>
        <span class="sw" style="background:${v.bg2}"></span>
        <span class="sw" style="background:${v.card}"></span>
        <span class="sw" style="background:${v.text}"></span>
        <span class="sw" style="background:${v.muted}"></span>
        <span class="sw" style="background:${v.border}"></span>
        <span class="sw" style="background:${v.accent}"></span>
        <span class="sw" style="background:${v.accent2}"></span>
      </div>
      <div class="muted" style="margin-top:6px">Fade: ${v.fade_amount||10}% every ${v.fade_seconds||10}s</div>
      <div class="row" style="margin-top:8px">
        <button class="btn apply">Apply</button>
        ${showDelete ? `<button class="btn danger del">Delete</button>` : ''}
      </div>
    </div>`;
}
function wireThemeCards(container, mine){
  container.querySelectorAll('.tcard').forEach(card=>{
    const id = card.dataset.id;
    card.querySelector('.apply')?.addEventListener('click', async ()=>{
      const v = JSON.parse(atob(card.dataset.vars||''));
      applyTheme(v);
    });
    const delBtn = card.querySelector('.del');
    if (delBtn){
      delBtn.addEventListener('click', async ()=>{
        if (!(mine || ADMIN_ENABLED)) return toast('No permission');
        if (!confirm('Delete this theme?')) return;
        const { error } = await sb.from('themes').delete().eq('id', id);
        if (error){ toast('Delete failed'); return; }
        toast('Theme deleted'); loadPublicThemes(); loadMyThemes();
      });
    }
  });
}

async function loadPublicThemes(){
  const { data, error } = await sb.from('themes').select('id,name,vars,created_at').eq('is_public', true).order('created_at',{ascending:false}).limit(200);
  if (error){ console.error(error); return; }
  themeGrid.innerHTML = (data||[]).map(r => themeCard(r, false)).join('') || `<p class="muted">No public themes yet.</p>`;
  wireThemeCards(themeGrid, false);
}
async function loadMyThemes(){
  if (!user){ myThemeGrid.innerHTML = `<p class="muted">Login to manage your themes.</p>`; return; }
  const { data, error } = await sb.from('themes').select('id,name,vars,created_at').eq('owner_uid', user.id).order('created_at',{ascending:false});
  if (error){ console.error(error); return; }
  myThemeGrid.innerHTML = (data||[]).map(r => themeCard(r, true)).join('') || `<p class="muted">You haven't created any themes yet.</p>`;
  wireThemeCards(myThemeGrid, true);
}

/* Helpers */
function toast(msg, ms=2200){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', ms); }
function fmt(s){ s=Math.max(0,s|0); const m=(s/60)|0, r=(s%60)|0; return m+':' + (r<10?'0':'')+r; }
function esc(s=''){ return s.replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[m])); }
function placeholder(title,artist){
  const styles = getComputedStyle(document.documentElement);
  const c1 = styles.getPropertyValue('--bg').trim() || '#071012';
  const c2 = styles.getPropertyValue('--card').trim() || '#0e1518';
  const t1 = styles.getPropertyValue('--accent-2').trim() || '#8ff1e9';
  const t2 = styles.getPropertyValue('--accent').trim() || '#1dd2c3';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='640' height='400'>
    <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
      <stop offset='0%' stop-color='${c1}'/><stop offset='100%' stop-color='${c2}'/></linearGradient></defs>
    <rect width='100%' height='100%' fill='url(#g)'/>
    <text x='32' y='210' font-family='Inter,Segoe UI,Arial' font-size='38' fill='${t1}' font-weight='900'>${(title||'Untitled').slice(0,28)}</text>
    <text x='32' y='255' font-family='Inter,Segoe UI,Arial' font-size='22' fill='${t2}'>${(artist||'Unknown').slice(0,36)}</text>
  </svg>`;
  return 'data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(svg)));
}
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function dataURLtoBlob(dataURL){
  const [h,b] = dataURL.split(','); const mime = h.match(/:(.*?);/)[1];
  const bin = atob(b); const len = bin.length; const arr = new Uint8Array(len);
  for (let i=0;i<len;i++) arr[i]=bin.charCodeAt(i); return new Blob([arr], {type:mime});
}
function hexToRgba(hex, a){
  const h = hex.replace('#',''); const n = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
  const r = parseInt(n.slice(0,2),16), g=parseInt(n.slice(2,4),16), b=parseInt(n.slice(4,6),16);
  return `rgba(${r}, ${g}, ${b}, ${a})`;
}

/* Shortcuts */
window.addEventListener('keydown', e=>{
  if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if (e.code==='Slash' && !e.shiftKey){ e.preventDefault(); search.focus(); }
});

/* Start session */
sb.auth.getSession().then(()=>refreshUser());
</script>
</body>
</html>
